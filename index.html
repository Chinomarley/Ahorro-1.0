<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Fondo Ahorro CFE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 20px; }
    section { margin-bottom: 30px; padding: 15px; background: #f5f5f5; border-radius: 8px; }
    label, select { display: block; margin: 10px 0 5px; }
    input[type=range] { width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    #historial { display: none; }
  </style>
</head>
<body>
  <h1>ðŸ“„ Fondo Ahorro CFE</h1>

  <section>
    <h2>1. Subir papeleta</h2>
    <input type="file" id="upload" accept="image/*">
    <button id="procesarBtn">Procesar</button>
    <p><strong>Periodo:</strong> <span id="periodo">-</span></p>
    <p><strong>Sueldo base:</strong> $<span id="sueldoExtraido">0.00</span></p>
    <p><strong>Fondo ahorro descontado:</strong> $<span id="fondoExtraido">0.00</span></p>
    <p><strong>Porcentaje aportado:</strong> <span id="porcentajeCalculado">0%</span> <span id="advertencia" style="color:red;"></span></p>
    <button id="guardarBtn">Guardar en historial</button>
  </section>

  <section>
    <h2>2. SimulaciÃ³n manual</h2>
    <label>Porcentaje a aportar (%): <span id="manualPorcentaje">9.10</span>%</label>
    <input type="range" id="aporteManual" min="0" max="18.2" value="9.10" step="0.1">
    
    <label>Tiempo de ahorro:</label>
    <select id="tiempo">
      <option value="4">4 meses</option>
      <option value="8">8 meses</option>
      <option value="12" selected>12 meses</option>
    </select>

    <p><strong>Total simulado:</strong> <span id="simulado">$0.00</span></p>
  </section>

  <section>
    <button id="toggleHistorial">Ver historial por aÃ±o</button>
    <div id="historial">
      <table>
        <thead>
          <tr><th>Periodo</th><th>Sueldo</th><th>Fondo</th><th>%</th><th>CFE</th><th>Total</th></tr>
        </thead>
        <tbody id="tablaHistorial"></tbody>
      </table>
      <h3>Total acumulado: <span id="acumulado">$0.00</span></h3>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script>
    const upload = document.getElementById("upload");
    const procesarBtn = document.getElementById("procesarBtn");
    const guardarBtn = document.getElementById("guardarBtn");
    const sueldoSpan = document.getElementById("sueldoExtraido");
    const fondoSpan = document.getElementById("fondoExtraido");
    const porcentajeSpan = document.getElementById("porcentajeCalculado");
    const advertenciaSpan = document.getElementById("advertencia");
    const periodoSpan = document.getElementById("periodo");
    const aporteSlider = document.getElementById("aporteManual");
    const porcentajeManualSpan = document.getElementById("manualPorcentaje");
    const tiempoSelect = document.getElementById("tiempo");
    const simuladoSpan = document.getElementById("simulado");
    const historialBtn = document.getElementById("toggleHistorial");
    const historialDiv = document.getElementById("historial");

    let datosActuales = {};

    procesarBtn.addEventListener("click", async () => {
      const file = upload.files[0];
      if (!file) return alert("Selecciona una imagen primero.");
      const img = new Image();
      img.src = URL.createObjectURL(file);

      img.onload = async () => {
        const result = await Tesseract.recognize(img, 'spa');
        const text = result.data.text;

        const sueldoMatch = text.match(/SUELDO\\s*\\$?([\\d,]+\\.\\d{2})/i);
        const fondoMatch = text.match(/FONDO.*?\\$?([\\d,]+\\.\\d{2})/i);
        const periodoMatch = text.match(/PERIODO DE PAGO:\\s*(\\d{2}\\/\\d{2}\\/\\d{4})/i);

        const sueldo = sueldoMatch ? parseFloat(sueldoMatch[1].replace(/[,]/g, '')) : 0;
        const fondo = fondoMatch ? parseFloat(fondoMatch[1].replace(/[,]/g, '')) : 0;
        const periodo = periodoMatch ? periodoMatch[1] : "Sin periodo";

        sueldoSpan.textContent = sueldo.toFixed(2);
        fondoSpan.textContent = fondo.toFixed(2);
        periodoSpan.textContent = periodo;

        const porcentaje = sueldo > 0 ? (fondo / sueldo) * 100 : 0;
        porcentajeSpan.textContent = porcentaje.toFixed(2) + "%";
        advertenciaSpan.textContent = porcentaje > 9.1 ? "âš  CFE solo duplica hasta el 9.10%" : "";

        datosActuales = { sueldo, fondo, periodo, porcentaje };
        actualizarSimulado();
      };
    });

    guardarBtn.addEventListener("click", () => {
      if (!datosActuales.periodo) return alert("Primero procesa una papeleta.");
      let historial = JSON.parse(localStorage.getItem("historialFondo")) || [];

      if (historial.some(e => e.periodo === datosActuales.periodo)) {
        alert("Ya procesaste esta papeleta.");
        return;
      }

      const cfe = Math.min(datosActuales.porcentaje, 9.1) / 100 * datosActuales.sueldo;
      const total = datosActuales.fondo + cfe;

      historial.push({ ...datosActuales, cfe, total });
      localStorage.setItem("historialFondo", JSON.stringify(historial));
      renderHistorial();
    });

    function renderHistorial() {
      const tabla = document.getElementById("tablaHistorial");
      tabla.innerHTML = "";
      const historial = JSON.parse(localStorage.getItem("historialFondo")) || [];
      let acumulado = 0;
      historial.forEach(h => {
        acumulado += h.total;
        tabla.innerHTML += `
          <tr>
            <td>${h.periodo}</td>
            <td>$${h.sueldo.toFixed(2)}</td>
            <td>$${h.fondo.toFixed(2)}</td>
            <td>${h.porcentaje.toFixed(2)}%</td>
            <td>$${h.cfe.toFixed(2)}</td>
            <td>$${h.total.toFixed(2)}</td>
          </tr>`;
      });
      document.getElementById("acumulado").textContent = "$" + acumulado.toFixed(2);
    }

    function actualizarSimulado() {
      const porcentaje = parseFloat(aporteSlider.value);
      const meses = parseInt(tiempoSelect.value);
      porcentajeManualSpan.textContent = porcentaje.toFixed(1);

      if (datosActuales.sueldo) {
        const aportacion = datosActuales.sueldo * (porcentaje / 100) * meses;
        const cfe = Math.min(porcentaje, 9.1) / 100 * datosActuales.sueldo * meses;
        simuladoSpan.textContent = "$" + (aportacion + cfe).toFixed(2);
      }
    }

    aporteSlider.addEventListener("input", actualizarSimulado);
    tiempoSelect.addEventListener("change", actualizarSimulado);
    historialBtn.addEventListener("click", () => {
      historialDiv.style.display = historialDiv.style.display === "none" ? "block" : "none";
    });

    renderHistorial();
  </script>
</body>
</html>